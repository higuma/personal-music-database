(function(){var t,e,i,n,r,s,a,l,o,u,c,h,d,m,p,f,y,w,v,b,g,k,S,x,V,C,I,B,D,A,M,N,L,O,T,U,F;g=["artist","release","track"],t={artist:"release",release:"track",track:null},y={},s={},f={},l={},a={},u={artist:{defaults:{name:""},validate:function(t){var e,i,n,r,a;if(i=t.name,""===i)return"Artist name is empty.";for(a=s.artist.models,n=0,r=a.length;r>n;n++)if(e=a[n],e!==this&&e.get("name")===i)return'Artist name "'+i+'" already exists.'}},release:{defaults:{title:"",year:(new Date).getFullYear(),artistId:null},validate:function(t){return""===t.title?"Release title is empty.":null==t.artistId?"Artist ID is not set.":void 0}},track:{defaults:{number:"0",title:"",minutes:"0",seconds:"00",releaseId:null},validate:function(t){return""===t.title?"Track title is empty.":null==t.releaseId?"Release ID is not set.":void 0}}};for(B in u)I=u[B],y[B]=Backbone.Model.extend(_.extend(I,{type:B}));b=Backbone.Collection.extend({setOwner:function(t){return this.owner===t?!1:(null!=(this.owner=t)?(this.localStorage=new Backbone.LocalStorage(this.localStorageKeyName()),this.fetch()):this.reset(),!0)},localStorageKeyName:function(){return this.owner?""+this.type+"-"+this.owner.id:this.type}}),x=function(){var t,e;return t=/^(?:THE|A)\s/,e=/\s/g,function(i,n,r){return i=i.get(r).toUpperCase().replace(t,"").replace(e,""),n=n.get(r).toUpperCase().replace(t,"").replace(e,""),n>i?-1:i>n?1:0}}(),S=function(t,e,i,n){var r,s;return r=Number(t.get(i)),s=Number(e.get(i)),s>r?-1:r>s?1:x(t,e,n)},e={artist:{inherits:Backbone.Collection,comparator:function(t,e){return x(t,e,"name")},localStorage:new Backbone.LocalStorage("artist")},release:{inherits:b,comparator:function(t,e){return S(t,e,"year","title")}},track:{inherits:b,comparator:function(t,e){return S(t,e,"number","title")}}};for(B in e)I=e[B],I=_.extend(I,{type:B,model:y[B]}),s[B]=new(I.inherits.extend(I));for(c={tagName:"li",className:"width-max",render:function(){return this.$el.html(this.template(this.model.toJSON()))}},D=0,L=g.length;L>D;D++)B=g[D],f[B]=Backbone.View.extend(_.extend(c,{template:_.template($("#template-"+B).html())}));for(n=Backbone.View.extend({events:{"click li":"onSelectItem"},initialize:function(t){return this.parentView=t.parentView,null!=this.parentView&&(this.parentView.childView=this),this.setListen(),this.selected=null},setListen:function(){return this.listenTo(this.items,"sync",this.onSync)},stopListen:function(){return this.stopListening(this.items)},render:function(){var t,e,i,n,r;for(this.$el.empty(),r=this.items.models,i=0,n=r.length;n>i;i++)t=r[i],e=new this.view({model:t}),e.render(),e.$el.attr("item-id",t.id),t===this.item&&e.$el.addClass("active"),this.$el.append(e.$el);return this},onSelectItem:function(t){var e,i;return $(".active",this.el).removeClass("active"),e=$(t.currentTarget),e.addClass("active"),i=e.attr("item-id"),this.item=this.items.get(i),this.syncChildView()},onSync:function(){return this.items.length>0?(null==this.item&&(this.item=this.items.models[0]),a[this.type].enable({"new":!0,edit:!0,"delete":!0})):(this.item=null,a[this.type].enable({"new":null==this.parentView||null!=this.items.owner,edit:!1,"delete":!1})),this.render(),this.syncChildView()},syncChildView:function(){return null!=this.childView?this.childView.syncFromParent(this.item):void 0},syncFromParent:function(t){return t!==this.items.owner?(this.item=null,this.items.setOwner(t)&&null==t?this.onSync():void 0):void 0},onUpdate:function(t){return this.item=t,this.items.sort(),this.onSync()},onDelete:function(t){var e;return e=this.items.length,e>0&&(t>=e&&(t=e-1),this.item=this.items.models[t]),this.onSync()}}),C=null,A=0,O=g.length;O>A;A++)B=g[A],V=n.extend({type:B,el:"#list-"+B,items:s[B],view:f[B]}),C=l[B]=new V({parentView:C});d=Backbone.View.extend({template:_.template($("#template-validation-error").html()),events:{"click .btn-primary":"apply"},titleMessage:{create:"New",update:"Edit"},applyMessage:{create:"Create",update:"Update"},initialize:function(){return"function"===$.type(this.controls)?this.controls=this.controls():void 0},show:function(t){var e,i,n,r,s;for(this.item=t,null!=this.item?(this.mode="update",i=this.item.attributes):(this.mode="create",i=this.defaults),this.renderAlert(),$(".modal-title",this.el).html(""+this.titleMessage[this.mode]+" "+this.type),$(".btn-primary",this.el).html(this.applyMessage[this.mode]),s=this.attributes,n=0,r=s.length;r>n;n++)e=s[n],this.controls[e].val(i[e]);return this.$el.modal("show")},apply:function(){var t,e,i,n,r,a,o,u;for(e={},u=this.attributes,a=0,o=u.length;o>a;a++)t=u[a],e[t]=this.controls[t].val();switch(this.mode){case"create":if(n=s[this.type],r=n.owner,null!=r&&(e[""+r.type+"Id"]=r.id),i=s[this.type].create(e,{wait:!0}),null!=i.validationError)return this.renderAlert(i),void i.destroy();break;case"update":if(!this.item.save(e))return this.renderAlert(this.item)}return l[this.type].onUpdate(this.item),this.$el.modal("hide")},renderAlert:function(t){return $(".alert-dismissible",this.el).remove(),null!=t?$(".modal-body",this.el).prepend(this.template(t)):void 0}}),o={artist:{attributes:["name"],defaults:{name:""},controls:function(){return{name:$('input[name="name"]',this.el)}}},release:{attributes:["title","year"],defaults:{title:"",year:(new Date).getFullYear()},controls:function(){return{title:$('input[name="title"]',this.el),year:$('select[name="year"]',this.el)}}},track:{attributes:["number","title","minutes","seconds"],defaults:{number:"0",title:"",minutes:"0",seconds:"00"},controls:function(){return{number:$('select[name="number"]',this.el),title:$('input[name="title"]',this.el),minutes:$('select[name="minutes"]',this.el),seconds:$('select[name="seconds"]',this.el)}}}},m={};for(B in o)I=o[B],I=_.extend(I,{el:"#modal-edit-"+B,type:B}),m[B]=new(d.extend(I));for(w={artist:"name",release:"title",track:"title"},h=function(){return new(V=Backbone.View.extend({el:"#modal-delete",events:{"click .btn-primary":"apply"},show:function(t,e){return this.type=t,this.item=e,$(".modal-title",this.el).html("Delete "+this.type+" - "+this.item.get(w[this.type])),$(".modal-body",this.el).html("Are you sure?"),this.$el.modal("show")},apply:function(){var t;return t=s[this.type].indexOf(this.item),r.clearItem(this.item),l[this.type].onDelete(t),this.$el.modal("hide")}}))}(),p={},F=["load-sample-data","clear-data","startup"],M=0,T=F.length;T>M;M++)k=F[M],V=Backbone.View.extend({el:"#modal-"+k,events:{"click .btn-primary":"apply"},show:function(t){return this.callback=t,this.$el.modal("show")},apply:function(){return $("body").addClass("cursor-wait"),$(".btn-primary",this.el).button("loading"),this.callback(this),this.$el.modal("hide")},resetButton:function(){return $("body").removeClass("cursor-wait"),$(".btn-primary",this.el).button("reset")}}),p[k]=new V;for(i=Backbone.View.extend({events:{"click li":"onMenu"},onMenu:function(t){var e;if(e=$(t.currentTarget),!e.hasClass("disabled"))switch(e.attr("action")){case"new":return m[this.type].show();case"edit":return m[this.type].show(this.controller.item);case"delete":return h.show(this.type,this.controller.item)}},enable:function(t){var e,i;i=[];for(k in t)e=t[k],i.push($("li[action='"+k+"']",this.el).toggleClass("disabled",!e));return i}}),N=0,U=g.length;U>N;N++)B=g[N],V=i.extend({el:"#menu-"+B,controller:l[B],type:B}),a[B]=new V;v=function(){return new(V=Backbone.View.extend({el:"#navbar-menu",events:{"click li":"onMenu"},onMenu:function(t){var e;return k=$(t.currentTarget).attr("action"),e=function(){switch(k){case"load-sample-data":return r.loadSampleData;case"clear-data":return r.clearData}}(),p[k].show(e)}}))}(),r=function(){var e,i,n,r,a,o,u,c;return n=function(e){var i,n;return null!=(n=t[e.type])&&(i=s[n],i.setOwner(e),r(i)),e.destroy()},r=function(t){for(var e;t.length>0;)n(t.models[0]);return e=t.localStorage,e.localStorage().removeItem(e.name)},e=function(){return r(s.artist)},o=function(t){return t.resetButton(),l.artist.item=null,l.artist.onSync()},u=function(){var t,e,i;for(i=[],e=0,t=g.length;t>e;e++)B=g[e],i.push(l[B].setListen());return i},c=function(){var t,e,i;for(i=[],e=0,t=g.length;t>e;e++)B=g[e],i.push(l[B].stopListen());return i},i=function(t){return c(),e(),u(),o(t)},a=function(t){return c(),e(),$.getJSON("data/data.json",function(e){var i,n,r,a,l,c,h,d,m,p,f,y,w,v,b,g;for(r=s.artist,d=s.release,y=s.track,v=0,w=e.length;w>v;v++){i=e[v],null==(n=r.findWhere({name:i.artist}))&&(n=r.create({name:i.artist})),d.setOwner(n),h=d.create({title:i.title,year:i.year,artistId:n.id}),y.setOwner(h),b=i.tracks;for(c in b)p=b[c],f=p[0],a=p[1],g=a.split(":"),l=g[0],m=g[1],y.create({number:c,title:f,minutes:l,seconds:m,releaseId:h.id})}return u(),o(t)})},{clearItem:n,clearItems:r,clearData:i,loadSampleData:a}}(),s.artist.fetch().done(function(){return 0===s.artist.length?p.startup.show(r.loadSampleData):void 0})}).call(this);